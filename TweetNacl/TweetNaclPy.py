q=1<<255;P=q-19;R=range;M=1<<32;L=lambda a:[(a>>i*32)%M for i in R(4)]
def m(s,p):
 s&=~q-7;s|=q>>1;p&=~q;b=p;a=d=1;c=0
 for i in bin(s)[2:]:
  if i=="1":a,b,c,d=b,a,d,c
  C=4*a*c*(486662*a*c+a*a+c*c)%P;A=(a*a-c*c)**2%P;D=p*4*(a*d-b*c)**2%P;B=4*(a*b-c*d)**2%P;a,b,c,d=[(A,B,C,D),(B,A,D,C)][i>"0"]
 return a*pow(c,P-2,P)%P
def s(l):
 def t(a,b,c,e):d=l[b]+l[c];l[a]^=(d<<e^d%M>>(32-e))%M
 for a,b,c,d in[(0,4,8,12),(5,9,13,1),(10,14,2,6),(15,3,7,11),(0,1,2,3),(5,6,7,4),(10,11,8,9),(15,12,13,14)]*10:t(b,a,d,7);t(c,b,a,9);t(d,c,b,13);t(a,d,c,18)
def h(k,K,n,b):l=[0]*16;l[::5]=L(0x6b20657479622d323320646e61707865);l[6:10]=n;l[1:5]=k;l[11:15]=K;a=l.copy();s(l);return l[::5]+l[6:10]if b else[(l[i]+a[i])%M for i in R(16)]
S=lambda k,n,p:[p[i]^h(k[:4],k[4:],L(n>>128^(i>>6)<<64),False)[i//4%16]>>(i%4*8)&255 for i in R(len(p))]
def B(a):
 o=0
 for i in a[::-1]:o<<=8;o^=i
 return o
def p(m):
 k=0;l=m[32:]
 while l:k+=B(l[:16]+[1]);k*=B(m[:16])&0x0ffffffc0ffffffc0ffffffc0fffffff;k%=(1<<130)-5;l=l[16:]
 return (k+B(m[16:32]))%(1<<128);
def K(s,k,n):k=m(s,k);k=h(L(k),L(k>>128),L(0),True);return h(k[:4],k[4:],L(n),True)
G=lambda s:m(s,9)
def E(s,k,n,t):k=S(K(s,k,n),n,[0]*32+t);return[p(k)>>(i*8)&255 for i in R(16)]+k[32:]
def D(s,k,n,t):k=S(K(s,k,n),n,[0]*32+t[16:]);return[p(k[:32]+t[16:])>>(i*8)&255 for i in R(16)]==t[:16]and k[32:]

 
 


ask=0x2a2cb91da5fb77b12a99c0eb872f4cdf4566b25172c1163c7da518730a6d0777;apk=G(ask)
bsk=0xebe088ff278b2f1cfdb6182629b13b6fe60e80838b7fe1794b8a4a627e08ab5d;bpk=G(bsk)
n=0x370b7a6b03e01982d673fc75a8bd62cd732bb655e96e6969

pt=[0xbe,0x07,0x5f,0xc5,0x3c,0x81,0xf2,0xd5
,0xcf,0x14,0x13,0x16,0xeb,0xeb,0x0c,0x7b
,0x52,0x28,0xc5,0x2a,0x4c,0x62,0xcb,0xd4
,0x4b,0x66,0x84,0x9b,0x64,0x24,0x4f,0xfc
,0xe5,0xec,0xba,0xaf,0x33,0xbd,0x75,0x1a
,0x1a,0xc7,0x28,0xd4,0x5e,0x6c,0x61,0x29
,0x6c,0xdc,0x3c,0x01,0x23,0x35,0x61,0xf4
,0x1d,0xb6,0x6c,0xce,0x31,0x4a,0xdb,0x31
,0x0e,0x3b,0xe8,0x25,0x0c,0x46,0xf0,0x6d
,0xce,0xea,0x3a,0x7f,0xa1,0x34,0x80,0x57
,0xe2,0xf6,0x55,0x6a,0xd6,0xb1,0x31,0x8a
,0x02,0x4a,0x83,0x8f,0x21,0xaf,0x1f,0xde
,0x04,0x89,0x77,0xeb,0x48,0xf5,0x9f,0xfd
,0x49,0x24,0xca,0x1c,0x60,0x90,0x2e,0x52
,0xf0,0xa0,0x89,0xbc,0x76,0x89,0x70,0x40
,0xe0,0x82,0xf9,0x37,0x76,0x38,0x48,0x64
,0x5e,0x07,0x05]

ct = [0xf3,0xff,0xc7,0x70,0x3f,0x94,0x00,0xe5
,0x2a,0x7d,0xfb,0x4b,0x3d,0x33,0x05,0xd9
,0x8e,0x99,0x3b,0x9f,0x48,0x68,0x12,0x73
,0xc2,0x96,0x50,0xba,0x32,0xfc,0x76,0xce
,0x48,0x33,0x2e,0xa7,0x16,0x4d,0x96,0xa4
,0x47,0x6f,0xb8,0xc5,0x31,0xa1,0x18,0x6a
,0xc0,0xdf,0xc1,0x7c,0x98,0xdc,0xe8,0x7b
,0x4d,0xa7,0xf0,0x11,0xec,0x48,0xc9,0x72
,0x71,0xd2,0xc2,0x0f,0x9b,0x92,0x8f,0xe2
,0x27,0x0d,0x6f,0xb8,0x63,0xd5,0x17,0x38
,0xb4,0x8e,0xee,0xe3,0x14,0xa7,0xcc,0x8a
,0xb9,0x32,0x16,0x45,0x48,0xe5,0x26,0xae
,0x90,0x22,0x43,0x68,0x51,0x7a,0xcf,0xea
,0xbd,0x6b,0xb3,0x73,0x2b,0xc0,0xe9,0xda
,0x99,0x83,0x2b,0x61,0xca,0x01,0xb6,0xde
,0x56,0x24,0x4a,0x9e,0x88,0xd5,0xf9,0xb3
,0x79,0x73,0xf6,0x22,0xa4,0x3d,0x14,0xa6
,0x59,0x9b,0x1f,0x65,0x4c,0xb4,0x5a,0x74
,0xe3,0x55,0xa5]

print([hex(i) for i in E(ask, bpk, n, pt)])
print(E(ask, bpk, n, pt) == ct)
print([hex(i) for i in D(bsk, apk, n, ct)])
print(D(bsk, apk, n, ct) == pt)
ct[0]=0
print(D(bsk, apk, n, ct))
